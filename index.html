<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ® Stock Options Arcade ðŸš€</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ˆ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes backgroundScroll {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes neonGlow {
            0%, 100% { box-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 40px #ff00ff; }
            50% { box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff, 0 0 30px #00ffff, 0 0 50px #00ffff; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(45deg, #1a0033, #330066, #660099, #9900cc);
            background-size: 400% 400%;
            animation: backgroundScroll 15s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: #fff;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 0, 255, 0.03) 2px, rgba(255, 0, 255, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0, 255, 255, 0.03) 2px, rgba(0, 255, 255, 0.03) 4px);
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 20px;
            padding: 40px;
            box-shadow:
                0 0 20px rgba(255, 0, 255, 0.5),
                0 0 40px rgba(0, 255, 255, 0.3),
                inset 0 0 60px rgba(255, 0, 255, 0.1);
            border: 3px solid #ff00ff;
            position: relative;
            z-index: 2;
        }

        h1 {
            text-align: center;
            color: #00ffff;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-family: 'Press Start 2P', cursive;
            text-shadow:
                0 0 10px #00ffff,
                0 0 20px #00ffff,
                0 0 30px #00ffff,
                0 0 40px #ff00ff,
                0 0 70px #ff00ff;
            animation: float 3s ease-in-out infinite;
        }

        .subtitle {
            text-align: center;
            color: #ffff00;
            margin-bottom: 30px;
            font-size: 0.9em;
            text-shadow: 0 0 10px #ffff00;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7em;
        }

        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: none;
            justify-content: center;
        }

        .tab {
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff00ff, #00ffff);
            border: 3px solid #ffff00;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 700;
            font-family: 'Press Start 2P', cursive;
            color: #000;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 5px 15px rgba(255, 0, 255, 0.4);
        }

        .tab:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 0, 255, 0.6);
            animation: neonGlow 1.5s infinite;
        }

        .tab.active {
            background: linear-gradient(45deg, #ffff00, #ff00ff);
            border-color: #00ffff;
            animation: pulse 2s infinite;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #00ffff;
            font-size: 0.9em;
            text-shadow: 0 0 5px #00ffff;
            text-transform: uppercase;
        }

        input[type="number"], input[type="text"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ff00ff;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(0, 0, 0, 0.5);
            color: #00ffff;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            background: rgba(0, 0, 0, 0.7);
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00);
            background-size: 200% 200%;
            animation: backgroundScroll 3s ease infinite;
            color: #000;
            border: 3px solid #ffff00;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 5px 20px rgba(255, 0, 255, 0.5);
        }

        .button:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(255, 0, 255, 0.8);
            animation: neonGlow 1s infinite, backgroundScroll 1s ease infinite;
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            border: 2px solid #ff00ff;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.3);
            display: none;
        }

        .results.show {
            display: block;
            animation: pulse 0.5s;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
            background: rgba(255, 0, 255, 0.1);
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #ffff00;
            text-shadow: 0 0 5px #ffff00;
        }

        .result-value {
            font-weight: 700;
            color: #00ffff;
            font-size: 1.2em;
            text-shadow: 0 0 10px #00ffff;
        }

        .result-value.positive {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        .result-value.negative {
            color: #ff0000;
            text-shadow: 0 0 10px #ff0000;
        }

        .vesting-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }

        .scenarios {
            margin-top: 20px;
        }

        .scenario-title {
            font-weight: 700;
            color: #ff00ff;
            margin-bottom: 10px;
            font-size: 1.1em;
            text-shadow: 0 0 10px #ff00ff;
        }

        .scenario-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 0, 255, 0.1);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            border: 1px solid rgba(255, 0, 255, 0.3);
        }

        .help-text {
            font-size: 0.75em;
            color: #999;
            margin-top: 4px;
            font-style: italic;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ff00ff;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(0, 0, 0, 0.5);
            color: #00ffff;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        select:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .chart-container h3 {
            color: #ffff00;
            text-shadow: 0 0 10px #ffff00;
        }

        canvas {
            max-height: 400px;
        }

        /* RSU-specific styles */
        .metric-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 0, 255, 0.1);
            border: 2px solid #ff00ff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
        }

        .metric-label {
            color: #ffff00;
            font-size: 0.7em;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
            text-shadow: 0 0 5px #ffff00;
        }

        .metric-value {
            color: #00ffff;
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 0 0 10px #00ffff;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 0, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: #00ffff;
        }

        .radio-label:hover {
            border-color: #ff00ff;
            background: rgba(255, 0, 255, 0.1);
        }

        .radio-label input[type="radio"] {
            width: auto;
            margin-right: 10px;
            accent-color: #ff00ff;
        }

        .radio-label input[type="radio"]:checked + span {
            color: #ffff00;
            font-weight: bold;
        }

        .tax-breakdown {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ffff;
            margin-bottom: 30px;
        }

        .tax-item {
            display: grid;
            grid-template-columns: 150px 1fr 120px;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }

        .tax-item:last-child {
            border-bottom: none;
        }

        .tax-item.total {
            border-top: 2px solid #ffff00;
            padding-top: 15px;
            margin-top: 10px;
        }

        .tax-label {
            color: #00ffff;
            font-size: 0.85em;
            font-weight: 600;
        }

        .tax-bar-container {
            background: rgba(0, 0, 0, 0.5);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 0, 255, 0.3);
        }

        .tax-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .tax-amount {
            color: #ffff00;
            font-weight: bold;
            text-align: right;
            text-shadow: 0 0 5px #ffff00;
        }

        .vesting-schedule {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff00ff;
            margin-top: 30px;
        }

        .vesting-table {
            width: 100%;
            border-collapse: collapse;
        }

        .vesting-table th {
            background: rgba(255, 0, 255, 0.2);
            color: #ffff00;
            padding: 12px;
            text-align: left;
            font-size: 0.8em;
            text-transform: uppercase;
            border: 1px solid rgba(255, 0, 255, 0.3);
        }

        .vesting-table td {
            padding: 10px 12px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            color: #00ffff;
            font-size: 0.85em;
        }

        .vesting-table tr:nth-child(even) {
            background: rgba(0, 255, 255, 0.05);
        }

        .vesting-table tr:hover {
            background: rgba(255, 0, 255, 0.1);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            .input-group {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.2em;
            }

            .subtitle {
                font-size: 0.5em;
            }

            .tabs {
                overflow-x: auto;
                flex-direction: column;
            }

            .tab {
                white-space: nowrap;
                font-size: 0.6em;
                padding: 10px 15px;
            }

            .button {
                font-size: 0.7em;
                padding: 15px;
            }

            .metric-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .tax-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .tax-bar-container {
                order: 2;
            }

            .tax-amount {
                text-align: left;
            }

            .vesting-table {
                font-size: 0.75em;
            }

            .vesting-table th,
            .vesting-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ’° OPTIONS ARCADE ðŸš€</h1>
        <p class="subtitle">LEVEL UP YOUR EQUITY GAME</p>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('simple')">ðŸŽ¯ Quick Play</button>
            <button class="tab" onclick="switchTab('vesting')">ðŸ“ˆ Timeline Mode</button>
            <button class="tab" onclick="switchTab('rsu')">ðŸ’Ž RSU Mode</button>
        </div>

        <div id="simple-tab" class="tab-content active">
        <form id="calculator-form">
            <div class="form-group">
                <label for="numOptions">Number of Options Granted</label>
                <input type="number" id="numOptions" min="0" step="1" value="10000" required>
                <div class="help-text">Total number of stock options you've been granted</div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="strikePrice">Strike Price ($)</label>
                    <input type="number" id="strikePrice" min="0" step="0.01" value="10" required>
                    <div class="help-text">Exercise price per share</div>
                </div>

                <div class="form-group">
                    <label for="currentPrice">Current Stock Price ($)</label>
                    <input type="number" id="currentPrice" min="0" step="0.01" value="50" required>
                    <div class="help-text">Current fair market value</div>
                </div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="vestedPercentage">Vested Percentage (%)</label>
                    <input type="number" id="vestedPercentage" min="0" max="100" step="1" value="25" required>
                    <div class="help-text">Percentage currently vested</div>
                </div>

                <div class="form-group">
                    <label for="taxRate">Tax Rate (%)</label>
                    <input type="number" id="taxRate" min="0" max="100" step="0.1" value="30" required>
                    <div class="help-text">Combined federal + state tax rate</div>
                </div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="minExitPrice">Min Exit Price ($)</label>
                    <input type="number" id="minExitPrice" min="0" step="1" value="25">
                    <div class="help-text">Minimum price for scenario range</div>
                </div>

                <div class="form-group">
                    <label for="maxExitPrice">Max Exit Price ($)</label>
                    <input type="number" id="maxExitPrice" min="0" step="1" value="150">
                    <div class="help-text">Maximum price for scenario range</div>
                </div>
            </div>

            <button type="submit" class="button">Calculate Value</button>
        </form>

        <div id="results" class="results">
            <div class="result-item">
                <span class="result-label">Current Intrinsic Value (All Options)</span>
                <span class="result-value" id="totalValue">$0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Gain per Option</span>
                <span class="result-value" id="gainPerOption">$0</span>
            </div>

            <div class="vesting-info">
                <div class="result-item">
                    <span class="result-label">Vested Options</span>
                    <span class="result-value" id="vestedOptions">0</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Unvested Options</span>
                    <span class="result-value" id="unvestedOptions">0</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Current Vested Value (Before Tax)</span>
                    <span class="result-value positive" id="vestedValue">$0</span>
                </div>
                <div class="result-item">
                    <span class="result-label">After-Tax Value (Vested)</span>
                    <span class="result-value positive" id="afterTaxValue">$0</span>
                </div>
            </div>

            <div id="scenariosContainer"></div>
        </div>

        <div id="simple-chart-results" class="results">
            <div class="chart-container">
                <h3 style="margin-bottom: 15px; color: #ffff00; text-shadow: 0 0 10px #ffff00; font-family: 'Press Start 2P', cursive; font-size: 0.9em;">Exit Scenario Comparison</h3>
                <canvas id="scenarioChart"></canvas>
            </div>
        </div>
        </div>

        <div id="vesting-tab" class="tab-content">
        <form id="vesting-form">
            <div class="form-group">
                <label for="vestNumOptions">Number of Options Granted</label>
                <input type="number" id="vestNumOptions" min="0" step="1" value="10000" required>
                <div class="help-text">Total number of stock options you've been granted</div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="vestStrikePrice">Strike Price ($)</label>
                    <input type="number" id="vestStrikePrice" min="0" step="0.01" value="10" required>
                    <div class="help-text">Exercise price per share</div>
                </div>

                <div class="form-group">
                    <label for="vestCurrentPrice">Current Stock Price ($)</label>
                    <input type="number" id="vestCurrentPrice" min="0" step="0.01" value="50" required>
                    <div class="help-text">Current fair market value</div>
                </div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="vestingPeriod">Vesting Period (years)</label>
                    <input type="number" id="vestingPeriod" min="1" max="10" step="0.5" value="4" required>
                    <div class="help-text">Total vesting duration</div>
                </div>

                <div class="form-group">
                    <label for="cliffPeriod">Cliff Period (years)</label>
                    <input type="number" id="cliffPeriod" min="0" max="5" step="0.25" value="1" required>
                    <div class="help-text">Time before first vesting</div>
                </div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="vestingFrequency">Vesting Frequency</label>
                    <select id="vestingFrequency" required>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="semi-annually">Semi-Annually</option>
                        <option value="annually">Annually</option>
                    </select>
                    <div class="help-text">How often options vest</div>
                </div>

                <div class="form-group">
                    <label for="vestTaxRate">Tax Rate (%)</label>
                    <input type="number" id="vestTaxRate" min="0" max="100" step="0.1" value="30" required>
                    <div class="help-text">Combined federal + state tax rate</div>
                </div>
            </div>

            <div class="form-group">
                <label for="grantDate">Grant Date</label>
                <input type="date" id="grantDate" required>
                <div class="help-text">When the options were granted</div>
            </div>

            <button type="submit" class="button">Generate Vesting Timeline</button>
        </form>

        <div id="vesting-results" class="results">
            <div class="chart-container">
                <h3 style="margin-bottom: 15px; color: #ffff00; text-shadow: 0 0 10px #ffff00; font-family: 'Press Start 2P', cursive; font-size: 0.9em;">Vested Options Over Time</h3>
                <canvas id="vestingOptionsChart"></canvas>
            </div>
            <div class="chart-container" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px; color: #ffff00; text-shadow: 0 0 10px #ffff00; font-family: 'Press Start 2P', cursive; font-size: 0.9em;">Value Over Time</h3>
                <canvas id="vestingValueChart"></canvas>
            </div>
        </div>
        </div>

        <div id="rsu-tab" class="tab-content">
        <form id="rsu-form">
            <div class="form-group">
                <label for="rsuNumShares">Number of RSUs</label>
                <input type="number" id="rsuNumShares" min="0" step="1" value="1000" required>
                <div class="help-text">Total shares granted</div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="rsuCurrentPrice">Current Stock Price ($)</label>
                    <input type="number" id="rsuCurrentPrice" min="0" step="0.01" value="100" required>
                    <div class="help-text">Fair market value per share</div>
                </div>

                <div class="form-group">
                    <label for="rsuGrantDate">Grant Date</label>
                    <input type="date" id="rsuGrantDate" required>
                    <div class="help-text">Start of vesting</div>
                </div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="rsuVestingPeriod">Vesting Period (years)</label>
                    <select id="rsuVestingPeriod" required>
                        <option value="1">1 Year</option>
                        <option value="2">2 Years</option>
                        <option value="3">3 Years</option>
                        <option value="4" selected>4 Years</option>
                        <option value="5">5 Years</option>
                        <option value="6">6 Years</option>
                    </select>
                    <div class="help-text">Total vesting duration</div>
                </div>

                <div class="form-group">
                    <label for="rsuCliffPeriod">Cliff Period</label>
                    <select id="rsuCliffPeriod" required>
                        <option value="0">None</option>
                        <option value="0.5">6 Months</option>
                        <option value="1" selected>1 Year</option>
                    </select>
                    <div class="help-text">Time before first vesting</div>
                </div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="rsuVestingFrequency">Vesting Frequency</label>
                    <select id="rsuVestingFrequency" required>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly" selected>Quarterly</option>
                        <option value="semi-annually">Semi-Annually</option>
                        <option value="annually">Annually</option>
                    </select>
                    <div class="help-text">How often RSUs vest</div>
                </div>

                <div class="form-group">
                    <label for="rsuVestingPattern">Vesting Pattern</label>
                    <select id="rsuVestingPattern" required>
                        <option value="linear" selected>Linear (Equal Yearly)</option>
                        <option value="backWeighted">Back-Weighted Amazon (5-15-40-40)</option>
                    </select>
                    <div class="help-text">Distribution pattern</div>
                </div>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label for="rsuFederalTaxRate">Federal Tax Rate (%)</label>
                    <input type="number" id="rsuFederalTaxRate" min="0" max="100" step="0.1" value="24" required>
                    <div class="help-text">Your marginal federal tax rate</div>
                </div>

                <div class="form-group">
                    <label for="rsuStateTaxRate">State Tax Rate (%)</label>
                    <input type="number" id="rsuStateTaxRate" min="0" max="100" step="0.1" value="5" required>
                    <div class="help-text">Your state income tax rate</div>
                </div>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="rsuIncludeFICA" style="width: auto; margin-right: 10px;">
                    <span>Include FICA Taxes (Social Security 6.2% + Medicare 1.45%)</span>
                </label>
                <div class="help-text">Optional: Add payroll taxes to calculation</div>
            </div>

            <div class="form-group">
                <label>Tax Withholding Method</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="rsuWithholdingMethod" value="sellToCover" checked>
                        <span>Sell-to-Cover (Company sells shares to pay taxes)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="rsuWithholdingMethod" value="cashPayment">
                        <span>Cash Payment (Pay taxes out of pocket)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="rsuWithholdingMethod" value="sameDaySale">
                        <span>Same-Day Sale (Sell all shares immediately)</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="rsuStockGrowth">Expected Stock Growth (%/year)</label>
                <input type="number" id="rsuStockGrowth" min="-100" max="1000" step="1" value="5">
                <div class="help-text">Optional: Projected annual growth rate</div>
            </div>

            <button type="submit" class="button">Calculate RSU Value</button>
        </form>

        <div id="rsu-results" class="results">
            <div class="metric-cards">
                <div class="metric-card">
                    <div class="metric-label">Total Grant Value</div>
                    <div class="metric-value" id="rsuTotalValue">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Net Value After Taxes</div>
                    <div class="metric-value positive" id="rsuNetValue">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Effective Tax Rate</div>
                    <div class="metric-value" id="rsuEffectiveTaxRate">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Net Shares You Keep</div>
                    <div class="metric-value" id="rsuNetShares">0</div>
                </div>
            </div>

            <div class="tax-breakdown">
                <h3 style="margin-bottom: 15px; color: #ffff00; text-shadow: 0 0 10px #ffff00; font-family: 'Press Start 2P', cursive; font-size: 0.8em;">Tax Breakdown</h3>
                <div class="tax-item">
                    <div class="tax-label">Federal Income Tax</div>
                    <div class="tax-bar-container">
                        <div class="tax-bar" id="rsuFederalTaxBar"></div>
                    </div>
                    <div class="tax-amount" id="rsuFederalTaxAmount">$0</div>
                </div>
                <div class="tax-item">
                    <div class="tax-label">State Income Tax</div>
                    <div class="tax-bar-container">
                        <div class="tax-bar" id="rsuStateTaxBar"></div>
                    </div>
                    <div class="tax-amount" id="rsuStateTaxAmount">$0</div>
                </div>
                <div class="tax-item" id="rsuSocialSecurityItem" style="display: none;">
                    <div class="tax-label">Social Security Tax</div>
                    <div class="tax-bar-container">
                        <div class="tax-bar" id="rsuSocialSecurityBar"></div>
                    </div>
                    <div class="tax-amount" id="rsuSocialSecurityAmount">$0</div>
                </div>
                <div class="tax-item" id="rsuMedicareItem" style="display: none;">
                    <div class="tax-label">Medicare Tax</div>
                    <div class="tax-bar-container">
                        <div class="tax-bar" id="rsuMedicareBar"></div>
                    </div>
                    <div class="tax-amount" id="rsuMedicareAmount">$0</div>
                </div>
                <div class="tax-item total">
                    <div class="tax-label">Total Tax Withholding</div>
                    <div class="tax-amount" id="rsuTotalTaxAmount" style="font-weight: bold;">$0</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 15px; color: #ffff00; text-shadow: 0 0 10px #ffff00; font-family: 'Press Start 2P', cursive; font-size: 0.9em;">RSU Value Over Time</h3>
                <canvas id="rsuValueChart"></canvas>
            </div>

            <div class="chart-container" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px; color: #ffff00; text-shadow: 0 0 10px #ffff00; font-family: 'Press Start 2P', cursive; font-size: 0.9em;">Tax Impact</h3>
                <canvas id="rsuTaxChart"></canvas>
            </div>

            <div class="chart-container" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px; color: #ffff00; text-shadow: 0 0 10px #ffff00; font-family: 'Press Start 2P', cursive; font-size: 0.9em;">Price Scenario Analysis</h3>
                <canvas id="rsuScenarioChart"></canvas>
            </div>

            <div class="vesting-schedule">
                <h3 style="margin-bottom: 15px; color: #ffff00; text-shadow: 0 0 10px #ffff00; font-family: 'Press Start 2P', cursive; font-size: 0.8em;">Vesting Schedule</h3>
                <div id="rsuVestingTable"></div>
            </div>
        </div>
        </div>
    </div>

    <script>
        document.getElementById('calculator-form').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateOptions();
        });

        function calculateOptions() {
            const numOptions = parseFloat(document.getElementById('numOptions').value);
            const strikePrice = parseFloat(document.getElementById('strikePrice').value);
            const currentPrice = parseFloat(document.getElementById('currentPrice').value);
            const vestedPercentage = parseFloat(document.getElementById('vestedPercentage').value);
            const taxRate = parseFloat(document.getElementById('taxRate').value);
            const minExitPrice = parseFloat(document.getElementById('minExitPrice').value);
            const maxExitPrice = parseFloat(document.getElementById('maxExitPrice').value);

            const gainPerOption = Math.max(0, currentPrice - strikePrice);
            const totalValue = gainPerOption * numOptions;

            const vestedOptions = Math.floor(numOptions * (vestedPercentage / 100));
            const unvestedOptions = numOptions - vestedOptions;
            const vestedValue = gainPerOption * vestedOptions;
            const afterTaxValue = vestedValue * (1 - taxRate / 100);

            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('gainPerOption').textContent = formatCurrency(gainPerOption);
            document.getElementById('vestedOptions').textContent = vestedOptions.toLocaleString();
            document.getElementById('unvestedOptions').textContent = unvestedOptions.toLocaleString();
            document.getElementById('vestedValue').textContent = formatCurrency(vestedValue);
            document.getElementById('afterTaxValue').textContent = formatCurrency(afterTaxValue);

            document.getElementById('gainPerOption').className = 'result-value ' + (gainPerOption > 0 ? 'positive' : 'negative');

            // Clear old scenarios container (not used anymore)
            const scenariosContainer = document.getElementById('scenariosContainer');
            scenariosContainer.textContent = '';

            // Create scenario comparison chart
            createScenarioChart(minExitPrice, maxExitPrice, strikePrice, currentPrice, vestedOptions, taxRate);

            document.getElementById('results').classList.add('show');
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Scenario chart
        let scenarioChart = null;

        function createScenarioChart(minExitPrice, maxExitPrice, strikePrice, currentPrice, vestedOptions, taxRate) {
            // Generate price range with reasonable intervals
            const priceRange = maxExitPrice - minExitPrice;
            const numberOfPoints = Math.min(20, Math.max(10, Math.ceil(priceRange / 5))); // 10-20 points
            const step = priceRange / (numberOfPoints - 1);

            const allPrices = [];
            for (let i = 0; i < numberOfPoints; i++) {
                allPrices.push(Math.round(minExitPrice + (step * i)));
            }

            // Make sure current price is highlighted if it's in range
            if (currentPrice >= minExitPrice && currentPrice <= maxExitPrice && !allPrices.includes(currentPrice)) {
                allPrices.push(currentPrice);
                allPrices.sort((a, b) => a - b);
            }

            const labels = allPrices.map(price => '$' + price.toFixed(0));
            const beforeTaxValues = allPrices.map(price => {
                const gain = Math.max(0, price - strikePrice);
                return gain * vestedOptions;
            });
            const afterTaxValues = beforeTaxValues.map(value => value * (1 - taxRate / 100));

            // Highlight current price
            const backgroundColors = allPrices.map(price =>
                price === currentPrice ? 'rgba(16, 185, 129, 0.9)' : 'rgba(16, 185, 129, 0.6)'
            );
            const afterTaxBackgroundColors = allPrices.map(price =>
                price === currentPrice ? 'rgba(118, 75, 162, 0.9)' : 'rgba(118, 75, 162, 0.6)'
            );

            const ctx = document.getElementById('scenarioChart').getContext('2d');

            if (scenarioChart) {
                scenarioChart.destroy();
            }

            scenarioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Before-Tax Value',
                            data: beforeTaxValues,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderColor: '#10b981',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'After-Tax Value',
                            data: afterTaxValues,
                            backgroundColor: 'rgba(118, 75, 162, 0.2)',
                            borderColor: '#764ba2',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const price = allPrices[context.dataIndex];
                                    let label = context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    if (price === currentPrice) {
                                        label += ' (Current Price)';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value ($)',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Stock Price per Share',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            }
                        }
                    }
                }
            });

            // Show the chart container
            document.getElementById('simple-chart-results').classList.add('show');
        }

        // Auto-calculate on input change
        const inputs = document.querySelectorAll('#simple-tab input[type="number"]');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                if (document.getElementById('results').classList.contains('show')) {
                    calculateOptions();
                }
            });
        });

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.getElementById('simple-tab').classList.remove('active');
            document.getElementById('vesting-tab').classList.remove('active');
            document.getElementById('rsu-tab').classList.remove('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Vesting timeline calculator
        let vestingOptionsChart = null;
        let vestingValueChart = null;

        // Set default grant date to today
        document.getElementById('grantDate').valueAsDate = new Date();

        document.getElementById('vesting-form').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateVestingTimeline();
        });

        function calculateVestingTimeline() {
            const numOptions = parseFloat(document.getElementById('vestNumOptions').value);
            const strikePrice = parseFloat(document.getElementById('vestStrikePrice').value);
            const currentPrice = parseFloat(document.getElementById('vestCurrentPrice').value);
            const vestingPeriod = parseFloat(document.getElementById('vestingPeriod').value);
            const cliffPeriod = parseFloat(document.getElementById('cliffPeriod').value);
            const frequency = document.getElementById('vestingFrequency').value;
            const taxRate = parseFloat(document.getElementById('vestTaxRate').value);
            const grantDate = new Date(document.getElementById('grantDate').value);

            // Calculate vesting intervals in months
            const frequencyMonths = {
                'monthly': 1,
                'quarterly': 3,
                'semi-annually': 6,
                'annually': 12
            };

            const intervalMonths = frequencyMonths[frequency];
            const totalMonths = vestingPeriod * 12;
            const cliffMonths = cliffPeriod * 12;

            // Calculate vesting schedule
            const vestingSchedule = [];
            const labels = [];
            const vestedOptions = [];
            const vestedPercentages = [];
            const vestedValues = [];
            const afterTaxValues = [];

            let currentMonth = 0;
            let totalVested = 0;

            // Before cliff
            while (currentMonth < cliffMonths) {
                const date = new Date(grantDate);
                date.setMonth(date.getMonth() + currentMonth);
                labels.push(formatDate(date));
                vestedOptions.push(0);
                vestedPercentages.push(0);
                vestedValues.push(0);
                afterTaxValues.push(0);
                currentMonth += intervalMonths;
            }

            // At cliff
            if (cliffMonths > 0) {
                const cliffVest = Math.floor(numOptions * (cliffMonths / totalMonths));
                totalVested = cliffVest;
                const date = new Date(grantDate);
                date.setMonth(date.getMonth() + cliffMonths);
                labels.push(formatDate(date));
                vestedOptions.push(totalVested);
                vestedPercentages.push((totalVested / numOptions) * 100);
                const value = totalVested * Math.max(0, currentPrice - strikePrice);
                vestedValues.push(value);
                afterTaxValues.push(value * (1 - taxRate / 100));
                currentMonth = cliffMonths + intervalMonths;
            }

            // After cliff
            while (currentMonth <= totalMonths) {
                const vestPercentage = currentMonth / totalMonths;
                totalVested = Math.min(numOptions, Math.floor(numOptions * vestPercentage));

                const date = new Date(grantDate);
                date.setMonth(date.getMonth() + currentMonth);
                labels.push(formatDate(date));
                vestedOptions.push(totalVested);
                vestedPercentages.push((totalVested / numOptions) * 100);

                const value = totalVested * Math.max(0, currentPrice - strikePrice);
                vestedValues.push(value);
                afterTaxValues.push(value * (1 - taxRate / 100));

                currentMonth += intervalMonths;
            }

            // Create first chart - Vested Options
            const optionsCtx = document.getElementById('vestingOptionsChart').getContext('2d');

            if (vestingOptionsChart) {
                vestingOptionsChart.destroy();
            }

            vestingOptionsChart = new Chart(optionsCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Vested Options',
                            data: vestedOptions,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            fill: true,
                            tension: 0.1,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const optionCount = vestedOptions[context.dataIndex];
                                    const percentage = vestedPercentages[context.dataIndex];
                                    return [
                                        optionCount.toLocaleString() + ' options vested',
                                        percentage.toFixed(1) + '% of total'
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Number of Options',
                                color: '#667eea',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Percentage Vested',
                                color: '#10b981',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                },
                                color: '#10b981'
                            },
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            }
                        }
                    }
                }
            });

            // Create second chart - Dollar Values
            const valueCtx = document.getElementById('vestingValueChart').getContext('2d');

            if (vestingValueChart) {
                vestingValueChart.destroy();
            }

            vestingValueChart = new Chart(valueCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Before-Tax Value',
                            data: vestedValues,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            fill: true,
                            tension: 0.1,
                            borderWidth: 3
                        },
                        {
                            label: 'After-Tax Value',
                            data: afterTaxValues,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.2)',
                            fill: true,
                            tension: 0.1,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            title: {
                                display: true,
                                text: 'Value ($)',
                                color: '#10b981',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            beginAtZero: true
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            }
                        }
                    }
                }
            });

            document.getElementById('vesting-results').classList.add('show');
        }

        function formatDate(date) {
            const options = { year: 'numeric', month: 'short' };
            return date.toLocaleDateString('en-US', options);
        }

        // RSU Calculator
        const RSU_TAX_RATES = {
            SOCIAL_SECURITY: 0.062,
            SS_WAGE_CAP: 168600,
            MEDICARE: 0.0145,
            MEDICARE_ADDITIONAL: 0.009,
            MEDICARE_THRESHOLD: 200000
        };

        const VESTING_PATTERNS = {
            linear: [0.25, 0.25, 0.25, 0.25],
            backWeighted: [0.05, 0.15, 0.40, 0.40]
        };

        // Set default RSU grant date to today
        document.getElementById('rsuGrantDate').valueAsDate = new Date();

        let rsuValueChart = null;
        let rsuTaxChart = null;
        let rsuScenarioChart = null;

        document.getElementById('rsu-form').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateRSU();
        });

        function calculateRSU() {
            // Get form values
            const numShares = parseFloat(document.getElementById('rsuNumShares').value);
            const currentPrice = parseFloat(document.getElementById('rsuCurrentPrice').value);
            const grantDate = new Date(document.getElementById('rsuGrantDate').value);
            const vestingPeriod = parseFloat(document.getElementById('rsuVestingPeriod').value);
            const cliffPeriod = parseFloat(document.getElementById('rsuCliffPeriod').value);
            const frequency = document.getElementById('rsuVestingFrequency').value;
            const vestingPattern = document.getElementById('rsuVestingPattern').value;
            const federalRate = parseFloat(document.getElementById('rsuFederalTaxRate').value) / 100;
            const stateRate = parseFloat(document.getElementById('rsuStateTaxRate').value) / 100;
            const includeFICA = document.getElementById('rsuIncludeFICA').checked;
            const withholdingMethod = document.querySelector('input[name="rsuWithholdingMethod"]:checked').value;
            const stockGrowth = parseFloat(document.getElementById('rsuStockGrowth').value) / 100;

            // Generate vesting schedule
            const vestingSchedule = generateRSUVestingSchedule(
                numShares, grantDate, vestingPeriod, cliffPeriod, frequency, vestingPattern
            );

            // Calculate total values
            const totalGrantValue = numShares * currentPrice;
            const taxes = calculateRSUTaxes(totalGrantValue, federalRate, stateRate, includeFICA);
            const netValue = totalGrantValue - taxes.totalTax;
            const effectiveTaxRate = (taxes.totalTax / totalGrantValue) * 100;

            // Calculate net shares based on withholding method
            let netShares = numShares;
            if (withholdingMethod === 'sellToCover') {
                const sharesWithheld = Math.ceil(taxes.totalTax / currentPrice);
                netShares = numShares - sharesWithheld;
            } else if (withholdingMethod === 'sameDaySale') {
                netShares = 0; // All shares sold
            }

            // Update summary metrics
            document.getElementById('rsuTotalValue').textContent = formatCurrency(totalGrantValue);
            document.getElementById('rsuNetValue').textContent = formatCurrency(netValue);
            document.getElementById('rsuEffectiveTaxRate').textContent = effectiveTaxRate.toFixed(1) + '%';
            document.getElementById('rsuNetShares').textContent =
                withholdingMethod === 'sameDaySale'
                    ? formatCurrency(netValue) + ' (cash)'
                    : netShares.toLocaleString() + ' shares';

            // Update tax breakdown
            updateTaxBreakdown(taxes, totalGrantValue, includeFICA);

            // Create charts
            createRSUValueChart(vestingSchedule, currentPrice, stockGrowth, federalRate, stateRate, includeFICA);
            createRSUTaxChart(taxes);
            createRSUScenarioChart(numShares, currentPrice, federalRate, stateRate, includeFICA);

            // Create vesting table
            createVestingTable(vestingSchedule, currentPrice, federalRate, stateRate, includeFICA, withholdingMethod);

            // Show results
            document.getElementById('rsu-results').classList.add('show');
        }

        function calculateRSUTaxes(grossValue, federalRate, stateRate, includeFICA) {
            const federalTax = grossValue * federalRate;
            const stateTax = grossValue * stateRate;

            let socialSecurityTax = 0;
            let medicareTax = 0;

            if (includeFICA) {
                // Social Security (capped at wage base)
                const ssBase = Math.min(grossValue, RSU_TAX_RATES.SS_WAGE_CAP);
                socialSecurityTax = ssBase * RSU_TAX_RATES.SOCIAL_SECURITY;

                // Medicare (with additional tax for high earners)
                medicareTax = grossValue * RSU_TAX_RATES.MEDICARE;
                if (grossValue > RSU_TAX_RATES.MEDICARE_THRESHOLD) {
                    const additionalMedicareBase = grossValue - RSU_TAX_RATES.MEDICARE_THRESHOLD;
                    medicareTax += additionalMedicareBase * RSU_TAX_RATES.MEDICARE_ADDITIONAL;
                }
            }

            const totalTax = federalTax + stateTax + socialSecurityTax + medicareTax;

            return {
                federalTax,
                stateTax,
                socialSecurityTax,
                medicareTax,
                totalTax
            };
        }

        function generateRSUVestingSchedule(numShares, grantDate, vestingPeriod, cliffPeriod, frequency, pattern) {
            const schedule = [];
            const frequencyMonths = {
                'monthly': 1,
                'quarterly': 3,
                'semi-annually': 6,
                'annually': 12
            };

            const intervalMonths = frequencyMonths[frequency];
            const totalMonths = vestingPeriod * 12;
            const cliffMonths = cliffPeriod * 12;

            // Get vesting pattern percentages
            const patternPercentages = VESTING_PATTERNS[pattern];
            const yearsInPeriod = vestingPeriod;

            // Normalize pattern to actual vesting period if needed
            let yearlyPercentages = [];
            if (patternPercentages.length === yearsInPeriod) {
                yearlyPercentages = patternPercentages;
            } else if (patternPercentages.length === 4 && yearsInPeriod !== 4) {
                // For linear pattern, distribute evenly
                const percentPerYear = 1 / yearsInPeriod;
                for (let i = 0; i < yearsInPeriod; i++) {
                    yearlyPercentages.push(percentPerYear);
                }
            } else {
                yearlyPercentages = patternPercentages;
            }

            let cumulativeVested = 0;
            let currentMonth = cliffMonths > 0 ? cliffMonths : intervalMonths;

            while (currentMonth <= totalMonths) {
                const yearsElapsed = currentMonth / 12;
                const currentYear = Math.floor(yearsElapsed);
                const progressInYear = (yearsElapsed - currentYear);

                // Calculate target vested amount based on pattern
                let targetVested = 0;
                for (let y = 0; y < currentYear && y < yearlyPercentages.length; y++) {
                    targetVested += yearlyPercentages[y];
                }
                if (currentYear < yearlyPercentages.length) {
                    targetVested += yearlyPercentages[currentYear] * progressInYear;
                }

                targetVested = Math.min(1, targetVested);
                const targetShares = Math.floor(numShares * targetVested);
                const vestingShares = targetShares - cumulativeVested;

                if (vestingShares > 0) {
                    const vestDate = new Date(grantDate);
                    vestDate.setMonth(vestDate.getMonth() + currentMonth);

                    schedule.push({
                        date: vestDate,
                        shares: vestingShares,
                        cumulativeShares: targetShares,
                        cumulativePercent: (targetShares / numShares) * 100
                    });

                    cumulativeVested = targetShares;
                }

                currentMonth += intervalMonths;
            }

            // Ensure all shares are vested by the end
            const totalScheduled = schedule.reduce((sum, event) => sum + event.shares, 0);
            if (totalScheduled < numShares) {
                const lastEvent = schedule[schedule.length - 1];
                if (lastEvent) {
                    const remaining = numShares - totalScheduled;
                    lastEvent.shares += remaining;
                    lastEvent.cumulativeShares += remaining;
                    lastEvent.cumulativePercent = 100;
                }
            }

            return schedule;
        }

        function updateTaxBreakdown(taxes, totalValue, includeFICA) {
            const maxTax = taxes.totalTax;

            // Federal tax
            document.getElementById('rsuFederalTaxAmount').textContent = formatCurrency(taxes.federalTax);
            document.getElementById('rsuFederalTaxBar').style.width = ((taxes.federalTax / maxTax) * 100) + '%';

            // State tax
            document.getElementById('rsuStateTaxAmount').textContent = formatCurrency(taxes.stateTax);
            document.getElementById('rsuStateTaxBar').style.width = ((taxes.stateTax / maxTax) * 100) + '%';

            // Social Security
            const ssItem = document.getElementById('rsuSocialSecurityItem');
            if (includeFICA && taxes.socialSecurityTax > 0) {
                ssItem.style.display = 'grid';
                document.getElementById('rsuSocialSecurityAmount').textContent = formatCurrency(taxes.socialSecurityTax);
                document.getElementById('rsuSocialSecurityBar').style.width = ((taxes.socialSecurityTax / maxTax) * 100) + '%';
            } else {
                ssItem.style.display = 'none';
            }

            // Medicare
            const medicareItem = document.getElementById('rsuMedicareItem');
            if (includeFICA && taxes.medicareTax > 0) {
                medicareItem.style.display = 'grid';
                document.getElementById('rsuMedicareAmount').textContent = formatCurrency(taxes.medicareTax);
                document.getElementById('rsuMedicareBar').style.width = ((taxes.medicareTax / maxTax) * 100) + '%';
            } else {
                medicareItem.style.display = 'none';
            }

            // Total
            document.getElementById('rsuTotalTaxAmount').textContent = formatCurrency(taxes.totalTax);
        }

        function createVestingTable(schedule, currentPrice, federalRate, stateRate, includeFICA, withholdingMethod) {
            const container = document.getElementById('rsuVestingTable');

            // Clear existing content
            container.textContent = '';

            const table = document.createElement('table');
            table.className = 'vesting-table';

            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Vest Date', 'Shares', 'Cumulative', 'Gross Value', 'Taxes'];
            if (withholdingMethod === 'sellToCover') {
                headers.push('Net Shares');
            } else {
                headers.push('Net Value');
            }

            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create body
            const tbody = document.createElement('tbody');
            schedule.forEach(event => {
                const grossValue = event.shares * currentPrice;
                const taxes = calculateRSUTaxes(grossValue, federalRate, stateRate, includeFICA);
                const netValue = grossValue - taxes.totalTax;
                const sharesWithheld = Math.ceil(taxes.totalTax / currentPrice);
                const netShares = event.shares - sharesWithheld;

                const row = document.createElement('tr');

                const cells = [
                    formatDate(event.date),
                    event.shares.toLocaleString(),
                    event.cumulativeShares.toLocaleString() + ' (' + event.cumulativePercent.toFixed(1) + '%)',
                    formatCurrency(grossValue),
                    formatCurrency(taxes.totalTax)
                ];

                if (withholdingMethod === 'sellToCover') {
                    cells.push(netShares.toLocaleString());
                } else if (withholdingMethod === 'sameDaySale') {
                    cells.push(formatCurrency(netValue));
                } else {
                    cells.push(event.shares.toLocaleString());
                }

                cells.forEach(cellText => {
                    const td = document.createElement('td');
                    td.textContent = cellText;
                    row.appendChild(td);
                });

                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            container.appendChild(table);
        }

        function createRSUValueChart(schedule, currentPrice, stockGrowth, federalRate, stateRate, includeFICA) {
            const labels = [];
            const grossValues = [];
            const netValues = [];

            let cumulativeShares = 0;

            schedule.forEach(event => {
                cumulativeShares = event.cumulativeShares;
                const monthsElapsed = Math.round((event.date - schedule[0].date) / (1000 * 60 * 60 * 24 * 30));
                const yearsElapsed = monthsElapsed / 12;

                // Apply stock growth
                const projectedPrice = currentPrice * Math.pow(1 + stockGrowth, yearsElapsed);
                const grossValue = cumulativeShares * projectedPrice;
                const taxes = calculateRSUTaxes(grossValue, federalRate, stateRate, includeFICA);
                const netValue = grossValue - taxes.totalTax;

                labels.push(formatDate(event.date));
                grossValues.push(grossValue);
                netValues.push(netValue);
            });

            const ctx = document.getElementById('rsuValueChart').getContext('2d');

            if (rsuValueChart) {
                rsuValueChart.destroy();
            }

            rsuValueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Gross Value',
                            data: grossValues,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3
                        },
                        {
                            label: 'Net Value After Taxes',
                            data: netValues,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.2)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value ($)',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            }
                        }
                    }
                }
            });
        }

        function createRSUTaxChart(taxes) {
            const ctx = document.getElementById('rsuTaxChart').getContext('2d');

            if (rsuTaxChart) {
                rsuTaxChart.destroy();
            }

            const labels = [];
            const data = [];
            const colors = [];

            if (taxes.federalTax > 0) {
                labels.push('Federal Income Tax');
                data.push(taxes.federalTax);
                colors.push('rgba(255, 0, 255, 0.8)');
            }

            if (taxes.stateTax > 0) {
                labels.push('State Income Tax');
                data.push(taxes.stateTax);
                colors.push('rgba(0, 255, 255, 0.8)');
            }

            if (taxes.socialSecurityTax > 0) {
                labels.push('Social Security');
                data.push(taxes.socialSecurityTax);
                colors.push('rgba(255, 255, 0, 0.8)');
            }

            if (taxes.medicareTax > 0) {
                labels.push('Medicare');
                data.push(taxes.medicareTax);
                colors.push('rgba(0, 255, 0, 0.8)');
            }

            rsuTaxChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#000',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': ' + formatCurrency(value) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createRSUScenarioChart(numShares, currentPrice, federalRate, stateRate, includeFICA) {
            const ctx = document.getElementById('rsuScenarioChart').getContext('2d');

            if (rsuScenarioChart) {
                rsuScenarioChart.destroy();
            }

            // Create price scenarios
            const minPrice = currentPrice * 0.7;
            const maxPrice = currentPrice * 1.3;
            const priceStep = (maxPrice - minPrice) / 10;

            const prices = [];
            const grossValues = [];
            const netValues = [];

            for (let i = 0; i <= 10; i++) {
                const price = minPrice + (priceStep * i);
                prices.push('$' + price.toFixed(0));

                const grossValue = numShares * price;
                const taxes = calculateRSUTaxes(grossValue, federalRate, stateRate, includeFICA);
                const netValue = grossValue - taxes.totalTax;

                grossValues.push(grossValue);
                netValues.push(netValue);
            }

            rsuScenarioChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: prices,
                    datasets: [
                        {
                            label: 'Gross Value',
                            data: grossValues,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: '#10b981',
                            borderWidth: 2
                        },
                        {
                            label: 'Net Value After Taxes',
                            data: netValues,
                            backgroundColor: 'rgba(118, 75, 162, 0.6)',
                            borderColor: '#764ba2',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value ($)',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Stock Price per Share',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
